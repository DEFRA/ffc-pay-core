#!/usr/bin/env sh

notify_api_key="${NOTIFY_API_KEY:-}"
if [ -n "$notify_api_key" ] && (echo "$notify_api_key" | grep -q 'live\|prod\|statement-key'); then
  echo "⚠️  WARNING: You appear to be using a live Notify API key!"
  printf "Are you sure you want to continue? (Y/N) "
  read -r REPLY
  echo
  case $REPLY in
    [Yy]) ;;
    *) echo "Aborting... Update your API key to a smoke test or local key and then run exec bash before restarting this service."
       exit 1
       ;;
  esac
fi

notify_api_key_letter="${NOTIFY_API_KEY_LETTER:-}"
if [ -n "$notify_api_key_letter" ] && (echo "$notify_api_key_letter" | grep -q 'live'); then
  echo "⚠️  WARNING: You appear to be using a live Notify Letter API key!"
  printf "Are you sure you want to continue? (Y/N) "
  read -r REPLY
  echo
  case $REPLY in
    [Yy]) ;;
    *) echo "Aborting... Update your API key to a smoke test or local key and then run exec bash before restarting this service."
       exit 1
       ;;
  esac
fi

if [ -z "$(docker network ls --filter name=^ffc-pay$ --format={{.Name}})" ]; then
  echo "Creating ffc-pay Docker network"
  docker network create ffc-pay
fi

projectRoot="$(a="/$0"; a=${a%/*}; a=${a:-.}; a=${a#/}/; cd "$a/.." || return; pwd)"

# Default: run both payments and documents
payments="true"
documents="true"
failed_services=""
retry_services=""

show_help() {
  echo "
    Usage: path/to/ffc-pay-core [OPTION...]
    Run payment and document services.

    Options:
      -p, --Payments-only    run only payment services
      -d, --Documents-only  run only document services
      -h, --help             display this help text
      
    Default (no flags): runs both payment and document services
    "
}

start_service() {
  service_path="$1"
  service_name=$(basename "$service_path")
  is_retry="${2:-false}"
  
  if [ ! -d "$service_path" ]; then
    echo "⚠️  Warning: $service_name directory not found at $service_path"
    failed_services="${failed_services}${service_name} (not found)\n"
    return 1
  fi
  
  if [ ! -f "$service_path/scripts/start" ]; then
    echo "⚠️  Warning: $service_name start script not found"
    failed_services="${failed_services}${service_name} (no start script)\n"
    return 1
  fi
  
  if [ "$is_retry" = "true" ]; then
    echo "Retrying $service_name..."
  else
    echo "Starting $service_name..."
  fi
  
  # Capture output to check for errors but don't fail the script
  if ! "$service_path/scripts/start" -d 2>&1; then
    echo "⚠️  $service_name start script returned error"
    if [ "$is_retry" = "false" ]; then
      retry_services="${retry_services}${service_path}|"
    else
      failed_services="${failed_services}${service_name} (start failed)\n"
    fi
    return 1
  fi
  
  # Brief pause to allow container to initialize
  sleep 1
  
  # Check if container is running
  container_name=$(echo "$service_name" | tr '[:upper:]' '[:lower:]')
  if ! docker ps --filter "name=$container_name" --format "{{.Names}}" | grep -q "$container_name"; then
    echo "⚠️  Container for $service_name not running"
    if [ "$is_retry" = "false" ]; then
      retry_services="${retry_services}${service_path}|"
    else
      failed_services="${failed_services}${service_name} (container not running)\n"
    fi
    return 1
  fi
  
  echo "✓ $service_name started successfully"
  return 0
}

start_services_batch() {
  service_type="$1"
  shift
  services_list="$*"
  
  echo "=== Starting $service_type Services ==="
  
  # First pass: attempt to start all services
  for service in $services_list; do
    start_service "$service" "false" || true
  done
  
  echo
}

retry_failed_services() {
  if [ -z "$retry_services" ]; then
    return 0
  fi
  
  echo "=========================================="
  echo "Retrying Failed Services"
  echo "=========================================="
  echo
  
  # Convert pipe-separated list to space-separated
  services_to_retry=$(echo "$retry_services" | tr '|' ' ')
  temp_retry=""
  
  for service in $services_to_retry; do
    if [ -n "$service" ]; then
      start_service "$service" "true" || temp_retry="${temp_retry}${service}|"
    fi
  done
  
  retry_services="$temp_retry"
  echo
}

while :; do
  case $1 in
    -p|--Payments-only)
      documents="false"
      ;;
    -d|--Documents-only)
      payments="false"
      documents="true"
      ;;    
    -h|--help)
      show_help
      exit
      ;;
    *)
      break
  esac

  shift
done

cd "${projectRoot}"

echo "=========================================="
echo "Starting FFC Payment and Document Services"
echo "Payments: $payments | Documents: $documents"
echo "=========================================="
echo

if [ "${payments}" = "true" ]; then
  payment_services="./ffc-pay-batch-verifier ./ffc-pay-batch-processor ./ffc-pay-enrichment ./ffc-pay-processing ./ffc-pay-submission ./ffc-pay-file-publisher ./ffc-pay-file-receiver ./ffc-pay-responses ./ffc-pay-tracking ./ffc-pay-web ./ffc-pay-request-editor ./ffc-pay-event-hub ./ffc-pay-data-hub ./ffc-pay-report-generator ./ffc-pay-alerting ./ffc-pay-gateway ./ffc-pay-injection ./ffc-pay-xb ./ffc-pay-dps ./ffc-pay-demographics ./ffc-pay-fdmr"
  start_services_batch "Payment" $payment_services
fi

if [ "${documents}" = "true" ]; then
  document_services="./ffc-doc-statement-data ./ffc-doc-statement-constructor ./ffc-doc-statement-generator ./ffc-doc-statement-publisher ./ffc-doc-statement-receiver ./ffc-doc-alerting"
  start_services_batch "Document" $document_services
fi

# Retry any failed services once
if [ -n "$retry_services" ]; then
  echo "Some services failed to start. Waiting 3 seconds before retry..."
  sleep 3
  retry_failed_services
fi

if [ "${payments}" = "true" ]; then
  echo "=== Running Seed Data ==="
  if [ -f "ffc-pay-core/seed" ]; then
    ffc-pay-core/seed
  else
    echo "⚠️  Warning: seed script not found"
  fi
  echo
fi

echo "=========================================="
echo "Startup Complete"
echo "=========================================="

if [ -n "$failed_services" ]; then
  echo
  echo "❌ The following services failed to start after retry:"
  echo "=========================================="
  printf "%b" "$failed_services"
  echo "=========================================="
  echo
  echo "Please check the logs for more details."
  exit 1
else
  echo "✓ All services started successfully"
  exit 0
fi